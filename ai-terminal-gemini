#!/usr/bin/env python3
import os
import sys
import json
import configparser
import time
import threading
from pathlib import Path
import readline
from typing import Optional

try:
    import google.generativeai as genai
except ImportError:
    print("‚ùå –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ google-generativeai –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞")
    print("–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install google-generativeai")
    sys.exit(1)

class AITerminal:
    def __init__(self):
        self.config_dir = Path.home() / ".config"
        self.config_file = self.config_dir / "ai-terminal.conf"
        self.history_file = self.config_dir / "ai-terminal-history.json"
        self.config = None
        self.history = []
        self._stop_typing = False
        
        self.setup_config()
        self.setup_client()
        self.load_history()
    
    def setup_config(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"""
        if not self.config_file.exists():
            self.create_default_config()
            self.print_colored("üìÅ –ö–æ–Ω—Ñ–∏–≥ —Å–æ–∑–¥–∞–Ω: ", "blue", end="")
            print(f"{self.config_file}")
            self.print_colored("üîë –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤–∞—à API –∫–ª—é—á –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ", "yellow")
            sys.exit(1)
        
        self.config = configparser.ConfigParser()
        self.config.read(self.config_file)
        
        api_key = self.config.get('api', 'api_key', fallback='YOUR_API_KEY_HERE')
        if api_key == 'YOUR_API_KEY_HERE':
            self.print_colored("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤–∞—à API –∫–ª—é—á –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ", "red")
            sys.exit(1)
    
    def create_default_config(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
        self.config_dir.mkdir(parents=True, exist_ok=True)
        
        config = configparser.ConfigParser()
        config['api'] = {
            'provider': 'gemini',
            'api_key': 'YOUR_API_KEY_HERE',
            'model_name': 'gemini-1.5-flash'
        }
        config['settings'] = {
            'system_prompt': 'You are a helpful AI assistant. Provide clear and concise answers in Russian. Be friendly and professional.',
            'temperature': '0.7',
            'max_tokens': '1024',
            'memory_depth': '5',
            'typing_effect': 'true',
            'typing_speed': '0.01'
        }
        
        with open(self.config_file, 'w') as f:
            config.write(f)
    
    def setup_client(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ Gemini"""
        try:
            api_key = self.config.get('api', 'api_key')
            genai.configure(api_key=api_key)
        except Exception as e:
            self.print_colored(f"‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞ Gemini: {e}", "red")
            sys.exit(1)
    
    def load_history(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞"""
        try:
            if self.history_file.exists():
                with open(self.history_file, 'r', encoding='utf-8') as f:
                    self.history = json.load(f)
            else:
                self.history = []
                self.save_history()
        except Exception as e:
            self.print_colored(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: {e}", "yellow")
            self.history = []
    
    def save_history(self):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞"""
        try:
            with open(self.history_file, 'w', encoding='utf-8') as f:
                json.dump(self.history, f, ensure_ascii=False, indent=2)
        except Exception as e:
            self.print_colored(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏: {e}", "yellow")
    
    def add_to_history(self, role, content):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—é"""
        self.history.append({"role": role, "content": content})
        
        memory_depth = self.config.getint('settings', 'memory_depth', fallback=5)
        max_history = memory_depth * 2
        if len(self.history) > max_history:
            self.history = self.history[-max_history:]
        
        self.save_history()
    
    def clear_history(self):
        """–û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞"""
        self.history = []
        self.save_history()
        self.print_colored("üßπ –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –æ—á–∏—â–µ–Ω–∞", "green")
    
    def print_colored(self, text: str, color: str, end: str = "\n"):
        """–ü–µ—á–∞—Ç—å —Ü–≤–µ—Ç–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞"""
        colors = {
            'red': '\033[91m',
            'green': '\033[92m',
            'yellow': '\033[93m',
            'blue': '\033[94m',
            'purple': '\033[95m',
            'cyan': '\033[96m',
            'white': '\033[97m',
        }
        reset = '\033[0m'
        
        color_code = colors.get(color, '')
        print(f"{color_code}{text}{reset}", end=end)
    
    def type_effect(self, text: str, delay: float = None):
        """–≠—Ñ—Ñ–µ–∫—Ç –ø–µ—á–∞—Ç–∏ —Å–∏–º–≤–æ–ª–æ–≤"""
        if delay is None:
            delay = self.config.getfloat('settings', 'typing_speed', fallback=0.01)
        
        self._stop_typing = False
        for char in text:
            if self._stop_typing:
                print(text[text.index(char):], end='', flush=True)
                break
            print(char, end='', flush=True)
            time.sleep(delay)
    
    def stop_typing(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞ –ø–µ—á–∞—Ç–∏"""
        self._stop_typing = True
    
    def print_header(self):
        """–ü–µ—á–∞—Ç—å –∫—Ä–∞—Å–∏–≤–æ–≥–æ –∑–∞–≥–æ–ª–æ–≤–∫–∞"""
        try:
            width = min(80, os.get_terminal_size().columns - 2)
        except:
            width = 78
        
        title = " AI-TERMINAL "
        title_width = len(title)
        remaining_width = width - title_width - 6
        
        left_dashes = "‚îÅ" * (remaining_width // 2)
        right_dashes = "‚îÅ" * (remaining_width - len(left_dashes))
        
        self.print_colored("‚îè‚îÅ‚îÅ" + left_dashes + title + right_dashes + "‚îÅ‚îÅ‚îì", "cyan")
    
    def print_line(self, text: str = "", prefix: str = "‚îÉ", color: str = "white"):
        """–ü–µ—á–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ –≤ —Ä–∞–º–∫–µ"""
        try:
            width = min(80, os.get_terminal_size().columns - 4)
        except:
            width = 76
        
        if text:
            lines = []
            current_line = ""
            for word in text.split():
                test_line = current_line + " " + word if current_line else word
                if len(test_line) <= width:
                    current_line = test_line
                else:
                    if current_line:
                        lines.append(current_line)
                    current_line = word
            if current_line:
                lines.append(current_line)
            
            for i, line in enumerate(lines):
                padding = " " * (width - len(line))
                prefix_symbol = "‚ùØ" if i == 0 else " "
                self.print_colored(f"{prefix} {prefix_symbol} {line}{padding} {prefix}", color)
        else:
            padding = " " * (width + 4)
            self.print_colored(f"{prefix}{padding}{prefix}", color)
    
    def print_separator(self):
        """–ü–µ—á–∞—Ç—å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è"""
        try:
            width = min(80, os.get_terminal_size().columns - 4)
        except:
            width = 76
        
        separator = "‚îÅ" * (width // 2 - 2) + "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" + "‚îÅ" * (width // 2 - 2)
        self.print_colored(f"‚îÉ {separator} ‚îÉ", "cyan")
    
    def print_response(self, question: str, answer: str):
        """–ö—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥ –≤–æ–ø—Ä–æ—Å–∞ –∏ –æ—Ç–≤–µ—Ç–∞"""
        self.print_header()
        self.print_line()
        
        # –í–æ–ø—Ä–æ—Å
        self.print_line(question, color="yellow")
        self.print_line()
        
        # –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å
        self.print_separator()
        self.print_line()
        
        # –û—Ç–≤–µ—Ç —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º –ø–µ—á–∞—Ç–∏
        typing_enabled = self.config.getboolean('settings', 'typing_effect', fallback=True)
        typing_speed = self.config.getfloat('settings', 'typing_speed', fallback=0.01)
        
        if typing_enabled:
            loading = threading.Event()
            loading_thread = threading.Thread(target=self._show_loading, args=(loading,))
            loading_thread.start()
            
            try:
                lines = answer.split('\n')
                for i, line in enumerate(lines):
                    if line.strip():
                        prefix = "‚îÉ"
                        prefix_symbol = "‚ùØ" if i == 0 else " "
                        try:
                            line_width = min(80, os.get_terminal_size().columns - 8)
                        except:
                            line_width = 72
                        
                        formatted_lines = []
                        current_line = ""
                        for word in line.split():
                            test_line = current_line + " " + word if current_line else word
                            if len(test_line) <= line_width:
                                current_line = test_line
                            else:
                                if current_line:
                                    formatted_lines.append(current_line)
                                current_line = word
                        if current_line:
                            formatted_lines.append(current_line)
                        
                        for j, formatted_line in enumerate(formatted_lines):
                            if j == 0 and i == 0:
                                padding = " " * (line_width - len(formatted_line) + 4)
                                sys.stdout.write(f"\r‚îÉ {prefix_symbol} {formatted_line}{padding} ‚îÉ\n")
                            else:
                                padding = " " * (line_width - len(formatted_line) + 6)
                                sys.stdout.write(f"\r‚îÉ   {formatted_line}{padding} ‚îÉ\n")
                            sys.stdout.flush()
                            time.sleep(typing_speed)
                
                loading.set()
                loading_thread.join()
                
            except KeyboardInterrupt:
                loading.set()
                loading_thread.join()
                self.stop_typing()
                print("\n")
                raise
        
        else:
            self.print_line(answer, color="green")
        
        self.print_line()
    
    def _show_loading(self, stop_event):
        """–ü–æ–∫–∞–∑–∞—Ç—å –∞–Ω–∏–º–∞—Ü–∏—é –∑–∞–≥—Ä—É–∑–∫–∏"""
        frames = ["‚†ã", "‚†ô", "‚†π", "‚†∏", "‚†º", "‚†¥", "‚†¶", "‚†ß", "‚†á", "‚†è"]
        i = 0
        
        while not stop_event.is_set():
            try:
                width = min(80, os.get_terminal_size().columns - 4)
            except:
                width = 76
            
            padding = " " * (width - 2)
            sys.stdout.write(f"\r‚îÉ {frames[i]} –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞{padding} ‚îÉ")
            sys.stdout.flush()
            time.sleep(0.1)
            i = (i + 1) % len(frames)
        
        try:
            width = min(80, os.get_terminal_size().columns - 4)
        except:
            width = 76
        padding = " " * (width + 2)
        sys.stdout.write(f"\r‚îÉ{padding}‚îÉ\r")
        sys.stdout.flush()
    
    def ask_ai(self, question: str) -> str:
        """–ó–∞–ø—Ä–æ—Å –∫ Gemini"""
        try:
            model_name = self.config.get('api', 'model_name', fallback='gemini-1.5-flash')
            model = genai.GenerativeModel(model_name)
            
            # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–º–ø—Ç —Å –∏—Å—Ç–æ—Ä–∏–µ–π
            prompt_parts = [self.config.get('settings', 'system_prompt')]
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
            for msg in self.history:
                if msg["role"] == "user":
                    prompt_parts.append(f"User: {msg['content']}")
                else:
                    prompt_parts.append(f"Assistant: {msg['content']}")
            
            prompt_parts.append(f"User: {question}")
            prompt_parts.append("Assistant:")
            
            full_prompt = "\n".join(prompt_parts)
            
            # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            generation_config = genai.types.GenerationConfig(
                temperature=self.config.getfloat('settings', 'temperature', fallback=0.7),
                max_output_tokens=self.config.getint('settings', 'max_tokens', fallback=1024),
            )
            
            response = model.generate_content(
                full_prompt,
                generation_config=generation_config
            )
            
            return response.text
            
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ Gemini API: {e}"
    
    def interactive_mode(self):
        """–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º"""
        self.print_colored("ü§ñ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≥–æ—Ç–æ–≤. –î–ª—è –≤—ã—Ö–æ–¥–∞ –≤–≤–µ–¥–∏—Ç–µ 'quit', 'exit' –∏–ª–∏ '–≤—ã—Ö–æ–¥'", "cyan")
        self.print_colored("–î–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –≤–≤–µ–¥–∏—Ç–µ 'clear'", "cyan")
        self.print_colored("–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–µ—á–∞—Ç–∏ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C", "cyan")
        
        while True:
            try:
                question = input("\n‚ùì –í–∞—à –≤–æ–ø—Ä–æ—Å: ").strip()
                
                if question.lower() in ['quit', 'exit', '–≤—ã—Ö–æ–¥']:
                    self.print_colored("üëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!", "green")
                    break
                elif question.lower() == 'clear':
                    self.clear_history()
                    continue
                elif not question:
                    continue
                
                answer = self.ask_ai(question)
                
                if answer.startswith("‚ùå"):
                    self.print_colored(answer, "red")
                else:
                    self.print_response(question, answer)
                    self.add_to_history("user", question)
                    self.add_to_history("assistant", answer)
                    
            except KeyboardInterrupt:
                self.print_colored("\nüëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!", "green")
                break
            except EOFError:
                self.print_colored("\nüëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!", "green")
                break
    
    def single_question(self, question: str):
        """–†–µ–∂–∏–º –æ–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞"""
        answer = self.ask_ai(question)
        
        if answer.startswith("‚ùå"):
            self.print_colored(answer, "red")
            sys.exit(1)
        else:
            self.print_response(question, answer)
            self.add_to_history("user", question)
            self.add_to_history("assistant", answer)

def show_help():
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É"""
    print("""ü§ñ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ (Gemini)

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
  ai-terminal [–≤–æ–ø—Ä–æ—Å]    - –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ò–ò
  ai-terminal             - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º
  ai-terminal --config    - –ü–æ–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É
  ai-terminal --reset     - –°–±—Ä–æ—Å–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
  ai-terminal --help      - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
  –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: ~/.config/ai-terminal.conf
  –ü–æ–ª—É—á–∏—Ç–µ API –∫–ª—é—á –Ω–∞: https://aistudio.google.com/
""")

def main():
    if len(sys.argv) > 1:
        arg = sys.argv[1]
        
        if arg in ['--help', '-h']:
            show_help()
            return
        elif arg == '--config':
            config_file = Path.home() / ".config" / "ai-terminal.conf"
            history_file = Path.home() / ".config" / "ai-terminal-history.json"
            print(f"üìÅ –ö–æ–Ω—Ñ–∏–≥: {config_file}")
            print(f"üìÅ –ò—Å—Ç–æ—Ä–∏—è: {history_file}")
            return
        elif arg == '--reset':
            history_file = Path.home() / ".config" / "ai-terminal-history.json"
            if history_file.exists():
                history_file.unlink()
                print("üßπ –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –æ—á–∏—â–µ–Ω–∞")
            else:
                print("‚ÑπÔ∏è –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ —É–∂–µ –ø—É—Å—Ç–∞")
            return
        elif arg.startswith('-'):
            print(f"‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç: {arg}")
            show_help()
            return
    
    try:
        assistant = AITerminal()
        
        if len(sys.argv) > 1:
            question = " ".join(sys.argv[1:])
            assistant.single_question(question)
        else:
            assistant.interactive_mode()
            
    except KeyboardInterrupt:
        print("\nüëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
    except Exception as e:
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
