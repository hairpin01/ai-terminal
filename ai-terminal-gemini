#!/usr/bin/env python3
import os
import sys
import json
import configparser
import time
import threading
from pathlib import Path
import readline
from typing import Optional

try:
    import google.generativeai as genai
except ImportError:
    print("‚ùå –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ google-generativeai –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞")
    print("–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ: pip install google-generativeai")
    sys.exit(1)

class AITerminal:
    def __init__(self):
        self.config_dir = Path.home() / ".config"
        self.config_file = self.config_dir / "ai-terminal.conf"
        self.history_file = self.config_dir / "ai-terminal-history.json"
        self.config = None
        self.history = []
        self._stop_typing = False
        self.available_models = []
        
        self.setup_config()
        self.setup_client()
        self.load_history()
        self.discover_models()
    
    def setup_config(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"""
        if not self.config_file.exists():
            self.create_default_config()
            print("üìÅ –ö–æ–Ω—Ñ–∏–≥ —Å–æ–∑–¥–∞–Ω:", self.config_file)
            print("üîë –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤–∞—à API –∫–ª—é—á –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ")
            sys.exit(1)
        
        self.config = configparser.ConfigParser()
        self.config.read(self.config_file)
        
        api_key = self.config.get('api', 'api_key', fallback='YOUR_API_KEY_HERE')
        if api_key == 'YOUR_API_KEY_HERE':
            print("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤–∞—à API –∫–ª—é—á –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ")
            sys.exit(1)
    
    def create_default_config(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
        self.config_dir.mkdir(parents=True, exist_ok=True)
        
        config = configparser.ConfigParser()
        config['api'] = {
            'provider': 'gemini',
            'api_key': 'YOUR_API_KEY_HERE',
            'model_name': 'models/gemini-1.5-flash'
        }
        config['settings'] = {
            'system_prompt': 'You are a helpful AI assistant. Provide clear and concise answers in Russian. Be friendly and professional.',
            'temperature': '0.7',
            'max_tokens': '1024',
            'memory_depth': '5',
            'typing_effect': 'true',
            'typing_speed': '0.01',
            'compact_mode': 'true'
        }
        
        with open(self.config_file, 'w') as f:
            config.write(f)
    
    def setup_client(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ Gemini"""
        try:
            api_key = self.config.get('api', 'api_key')
            genai.configure(api_key=api_key)
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞ Gemini: {e}")
            sys.exit(1)
    
    def discover_models(self):
        """–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π"""
        try:
            models = genai.list_models()
            self.available_models = [
                model.name for model in models 
                if 'generateContent' in model.supported_generation_methods
            ]
        except Exception:
            self.available_models = []
    
    def get_available_model(self):
        """–ü–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—É—é –º–æ–¥–µ–ª—å"""
        configured_model = self.config.get('api', 'model_name', fallback='models/gemini-1.5-flash')
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç—É–ø–Ω–∞ –ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å
        if configured_model in self.available_models:
            return configured_model
        
        # –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ–¥—Ö–æ–¥—è—â—É—é –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—É
        fallback_models = [
            'models/gemini-1.5-flash',
            'models/gemini-1.5-pro',
            'models/gemini-pro',
            'gemini-pro',
            'gemini-1.5-flash',
            'gemini-1.5-pro'
        ]
        
        for model in fallback_models:
            if model in self.available_models:
                return model
        
        # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é
        if self.available_models:
            return self.available_models[0]
        
        # –ï—Å–ª–∏ –º–æ–¥–µ–ª–µ–π –Ω–µ—Ç, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω—É—é
        return configured_model
    
    def load_history(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞"""
        try:
            if self.history_file.exists():
                with open(self.history_file, 'r', encoding='utf-8') as f:
                    self.history = json.load(f)
            else:
                self.history = []
                self.save_history()
        except Exception:
            self.history = []
    
    def save_history(self):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞"""
        try:
            with open(self.history_file, 'w', encoding='utf-8') as f:
                json.dump(self.history, f, ensure_ascii=False, indent=2)
        except Exception:
            pass
    
    def add_to_history(self, role, content):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—é"""
        self.history.append({"role": role, "content": content})
        
        memory_depth = self.config.getint('settings', 'memory_depth', fallback=5)
        max_history = memory_depth * 2
        if len(self.history) > max_history:
            self.history = self.history[-max_history:]
        
        self.save_history()
    
    def clear_history(self):
        """–û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞"""
        self.history = []
        self.save_history()
        print("üßπ –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –æ—á–∏—â–µ–Ω–∞")
    
    def type_effect(self, text: str, delay: float = None):
        """–≠—Ñ—Ñ–µ–∫—Ç –ø–µ—á–∞—Ç–∏ —Å–∏–º–≤–æ–ª–æ–≤"""
        if delay is None:
            delay = self.config.getfloat('settings', 'typing_speed', fallback=0.01)
        
        self._stop_typing = False
        for char in text:
            if self._stop_typing:
                print(text[text.index(char):], end='', flush=True)
                break
            print(char, end='', flush=True)
            time.sleep(delay)
        print()  # –ù–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
    
    def stop_typing(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞ –ø–µ—á–∞—Ç–∏"""
        self._stop_typing = True
    
    def _show_compact_loading(self, stop_event, question: str):
        """–ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏"""
        frames = ["‚†ã", "‚†ô", "‚†π", "‚†∏", "‚†º", "‚†¥", "‚†¶", "‚†ß", "‚†á", "‚†è"]
        i = 0
        
        # –°–Ω–∞—á–∞–ª–∞ –≤—ã–≤–æ–¥–∏–º –≤–æ–ø—Ä–æ—Å
        print(f"‚û°Ô∏è {question}")
        
        while not stop_event.is_set():
            sys.stdout.write(f"\rüîÑ {frames[i]} thinking...")
            sys.stdout.flush()
            time.sleep(0.1)
            i = (i + 1) % len(frames)
        
        # –û—á–∏—â–∞–µ–º —Å—Ç—Ä–æ–∫—É —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π
        sys.stdout.write("\r" + " " * 50 + "\r")
        sys.stdout.flush()
    
    def print_compact_response(self, question: str, answer: str):
        """–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –≤—ã–≤–æ–¥ –≤–æ–ø—Ä–æ—Å–∞ –∏ –æ—Ç–≤–µ—Ç–∞"""
        # –í–æ–ø—Ä–æ—Å
        print(f"‚û°Ô∏è {question}")
        
        # –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ (—É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ –∫ —ç—Ç–æ–º—É –º–æ–º–µ–Ω—Ç—É)
        
        # –û—Ç–≤–µ—Ç
        print("üîô ", end="", flush=True)
        
        typing_enabled = self.config.getboolean('settings', 'typing_effect', fallback=True)
        typing_speed = self.config.getfloat('settings', 'typing_speed', fallback=0.01)
        
        if typing_enabled:
            self.type_effect(answer)
        else:
            print(answer)
        
        print()  # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
    
    def ask_ai(self, question: str) -> str:
        """–ó–∞–ø—Ä–æ—Å –∫ Gemini"""
        try:
            model_name = self.get_available_model()
            model = genai.GenerativeModel(model_name)
            
            # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–º–ø—Ç —Å –∏—Å—Ç–æ—Ä–∏–µ–π
            prompt_parts = [self.config.get('settings', 'system_prompt')]
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
            for msg in self.history:
                if msg["role"] == "user":
                    prompt_parts.append(f"User: {msg['content']}")
                else:
                    prompt_parts.append(f"Assistant: {msg['content']}")
            
            prompt_parts.append(f"User: {question}")
            prompt_parts.append("Assistant:")
            
            full_prompt = "\n".join(prompt_parts)
            
            # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
            generation_config = genai.types.GenerationConfig(
                temperature=self.config.getfloat('settings', 'temperature', fallback=0.7),
                max_output_tokens=self.config.getint('settings', 'max_tokens', fallback=1024),
            )
            
            response = model.generate_content(
                full_prompt,
                generation_config=generation_config
            )
            
            return response.text
            
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞: {e}"
    
    def interactive_mode(self):
        """–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º"""
        print("üí¨ AI Terminal –≥–æ—Ç–æ–≤ –∫ –æ–±—â–µ–Ω–∏—é. 'quit' –¥–ª—è –≤—ã—Ö–æ–¥–∞, 'clear' –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏")
        print()
        
        while True:
            try:
                question = input("‚ùì ").strip()
                
                if question.lower() in ['quit', 'exit', '–≤—ã—Ö–æ–¥']:
                    print("üëã")
                    break
                elif question.lower() == 'clear':
                    self.clear_history()
                    continue
                elif not question:
                    continue
                
                # –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
                loading = threading.Event()
                loading_thread = threading.Thread(target=self._show_compact_loading, args=(loading, question))
                loading_thread.start()
                
                answer = self.ask_ai(question)
                
                loading.set()
                loading_thread.join()
                
                if answer.startswith("‚ùå"):
                    print(f"‚ùå {answer}")
                else:
                    self.print_compact_response(question, answer)
                    self.add_to_history("user", question)
                    self.add_to_history("assistant", answer)
                    
            except KeyboardInterrupt:
                print("\nüëã")
                break
            except EOFError:
                print("\nüëã")
                break
    
    def single_question(self, question: str):
        """–†–µ–∂–∏–º –æ–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞"""
        # –ö–æ–º–ø–∞–∫—Ç–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
        loading = threading.Event()
        loading_thread = threading.Thread(target=self._show_compact_loading, args=(loading, question))
        loading_thread.start()
        
        answer = self.ask_ai(question)
        
        loading.set()
        loading_thread.join()
        
        if answer.startswith("‚ùå"):
            print(f"‚ùå {answer}")
            sys.exit(1)
        else:
            self.print_compact_response(question, answer)
            self.add_to_history("user", question)
            self.add_to_history("assistant", answer)

def show_help():
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É"""
    print("""üí¨ AI Terminal - Gemini

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
  ai-terminal [–≤–æ–ø—Ä–æ—Å]    - –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å
  ai-terminal             - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º
  ai-terminal --config    - –ü–æ–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É
  ai-terminal --reset     - –°–±—Ä–æ—Å–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
  ai-terminal --help      - –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É

–ü—Ä–∏–º–µ—Ä:
  ai-terminal "–Ω–∞–ø–∏—à–∏ –∫–æ–¥ –Ω–∞ Python"
""")

def main():
    if len(sys.argv) > 1:
        arg = sys.argv[1]
        
        if arg in ['--help', '-h']:
            show_help()
            return
        elif arg == '--config':
            config_file = Path.home() / ".config" / "ai-terminal.conf"
            history_file = Path.home() / ".config" / "ai-terminal-history.json"
            print(f"üìÅ –ö–æ–Ω—Ñ–∏–≥: {config_file}")
            print(f"üìÅ –ò—Å—Ç–æ—Ä–∏—è: {history_file}")
            return
        elif arg == '--reset':
            history_file = Path.home() / ".config" / "ai-terminal-history.json"
            if history_file.exists():
                history_file.unlink()
                print("üßπ –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞")
            else:
                print("‚ÑπÔ∏è –ò—Å—Ç–æ—Ä–∏—è —É–∂–µ –ø—É—Å—Ç–∞")
            return
        elif arg.startswith('-'):
            print(f"‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç: {arg}")
            show_help()
            return
    
    try:
        assistant = AITerminal()
        
        if len(sys.argv) > 1:
            question = " ".join(sys.argv[1:])
            assistant.single_question(question)
        else:
            assistant.interactive_mode()
            
    except KeyboardInterrupt:
        print("\nüëã")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
