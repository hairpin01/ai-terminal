#!/usr/bin/env python3
import os
import sys
import json
import configparser
import time
import threading
from pathlib import Path
import openai

class AITerminal:
    def __init__(self):
        self.config_dir = Path.home() / ".config"
        self.config_file = self.config_dir / "ai-terminal.conf"
        self.history_file = self.config_dir / "ai-terminal-history.json"
        self.config = None
        self.history = []
        self.client = None
        self._stop_typing = False
        self._spinner_active = False
        
        self.setup_config()
        self.setup_client()
        self.load_history()
    
    def setup_config(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"""
        if not self.config_file.exists():
            self.create_default_config()
            print(f"üìÅ –ö–æ–Ω—Ñ–∏–≥ —Å–æ–∑–¥–∞–Ω: {self.config_file}")
            print("üîë –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ API –∫–ª—é—á –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ")
            sys.exit(1)
        
        self.config = configparser.ConfigParser()
        self.config.read(self.config_file)
        
        api_key = self.config.get('api', 'api_key', fallback='YOUR_API_KEY_HERE')
        if api_key == 'YOUR_API_KEY_HERE':
            print("‚ùå –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ API –∫–ª—é—á –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ")
            sys.exit(1)
    
    def create_default_config(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
        self.config_dir.mkdir(parents=True, exist_ok=True)
        
        config = configparser.ConfigParser()
        config['api'] = {
            'base_url': 'https://api.intelligence.io.solutions/api/v1/',
            'api_key': 'YOUR_API_KEY_HERE',
            'model_name': 'meta-llama/Llama-3.3-70B-Instruct'
        }
        config['settings'] = {
            'system_prompt': '–¢—ã –ø–æ–ª–µ–∑–Ω—ã–π AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –û—Ç–≤–µ—á–∞–π —è—Å–Ω–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º.',
            'temperature': '0.7',
            'max_tokens': '1024',
            'memory_depth': '5',
            'typing_effect': 'true',
            'typing_speed': '0.03',
            'waiting_animation': 'true'
        }
        
        with open(self.config_file, 'w') as f:
            config.write(f)
    
    def setup_client(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ OpenAI"""
        try:
            self.client = openai.OpenAI(
                api_key=self.config.get('api', 'api_key'),
                base_url=self.config.get('api', 'base_url')
            )
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞: {e}")
            sys.exit(1)
    
    def load_history(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞"""
        try:
            if self.history_file.exists():
                with open(self.history_file, 'r', encoding='utf-8') as f:
                    self.history = json.load(f)
            else:
                self.history = []
                self.save_history()
        except Exception:
            self.history = []
    
    def save_history(self):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞"""
        try:
            with open(self.history_file, 'w', encoding='utf-8') as f:
                json.dump(self.history, f, ensure_ascii=False, indent=2)
        except Exception:
            pass
    
    def add_to_history(self, role, content):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—é"""
        self.history.append({"role": role, "content": content})
        memory_depth = self.config.getint('settings', 'memory_depth', fallback=5)
        max_history = memory_depth * 2
        if len(self.history) > max_history:
            self.history = self.history[-max_history:]
        self.save_history()
    
    def clear_history(self):
        """–û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞"""
        self.history = []
        self.save_history()
        print("üßπ –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞")
    
    def show_waiting_animation(self):
        """–ê–Ω–∏–º–∞—Ü–∏—è –æ–∂–∏–¥–∞–Ω–∏—è"""
        animation_frames = ['|', '/', '-', '\\']
        i = 0
        
        while self._spinner_active:
            print(f'\r{animation_frames[i]} –û–∂–∏–¥–∞—é –æ—Ç–≤–µ—Ç–∞...', end='', flush=True)
            time.sleep(0.1)
            i = (i + 1) % len(animation_frames)
        
        # –û—á–∏—â–∞–µ–º —Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
        print('\r' + ' ' * 50 + '\r', end='', flush=True)
    
    def start_waiting_animation(self):
        """–ó–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è"""
        if not self.config.getboolean('settings', 'waiting_animation', fallback=True):
            return
            
        self._spinner_active = True
        animation_thread = threading.Thread(target=self.show_waiting_animation)
        animation_thread.daemon = True
        animation_thread.start()
        return animation_thread
    
    def stop_waiting_animation(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è"""
        self._spinner_active = False
        time.sleep(0.15)  # –î–∞–µ–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–∏
    
    def show_thinking_animation(self):
        """–ê–Ω–∏–º–∞—Ü–∏—è '–¥—É–º–∞–Ω–∏—è' —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ —Ç–æ—á–∫–∞–º–∏"""
        frames = ['‚†ã', '‚†ô', '‚†π', '‚†∏', '‚†º', '‚†¥', '‚†¶', '‚†ß', '‚†á', '‚†è']
        i = 0
        
        while self._spinner_active:
            print(f'\r{frames[i]} –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∑–∞–ø—Ä–æ—Å...', end='', flush=True)
            time.sleep(0.1)
            i = (i + 1) % len(frames)
        
        # –û—á–∏—â–∞–µ–º —Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ –∞–Ω–∏–º–∞—Ü–∏–∏
        print('\r' + ' ' * 50 + '\r', end='', flush=True)
    
    def start_thinking_animation(self):
        """–ó–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏ –¥—É–º–∞–Ω–∏—è"""
        if not self.config.getboolean('settings', 'waiting_animation', fallback=True):
            return
            
        self._spinner_active = True
        animation_thread = threading.Thread(target=self.show_thinking_animation)
        animation_thread.daemon = True
        animation_thread.start()
        return animation_thread
    
    def type_with_effect(self, text: str):
        """–≠—Ñ—Ñ–µ–∫—Ç –ø–µ—á–∞—Ç–∏ –ø–æ —Å–ª–æ–≤–∞–º –±–µ–∑ –∫—É—Ä—Å–æ—Ä–∞"""
        words = text.split(' ')
        typing_speed = self.config.getfloat('settings', 'typing_speed', fallback=0.03)
        
        # –ê–Ω–∏–º–∞—Ü–∏—è –Ω–∞—á–∞–ª–∞ –æ—Ç–≤–µ—Ç–∞
        print("ü§ñ ", end='', flush=True)
        
        for word_idx, word in enumerate(words):
            if self._stop_typing:
                # –í—ã–≤–æ–¥–∏–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —Å–ª–æ–≤–∞ –±–µ–∑ —ç—Ñ—Ñ–µ–∫—Ç–∞
                print(' '.join(words[word_idx:]), end='', flush=True)
                break
            
            # –í—ã–≤–æ–¥–∏–º —Å–ª–æ–≤–æ
            print(word, end='', flush=True)
            
            # –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–ª–æ–≤–æ, –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª
            if word_idx < len(words) - 1:
                print(' ', end='', flush=True)
            
            # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–ª–æ–≤–∞–º–∏
            time.sleep(typing_speed)
        
        print()  # –ó–∞–≤–µ—Ä—à–∞–µ–º —Å—Ç—Ä–æ–∫—É
    
    def type_with_wave_effect(self, text: str):
        """–≠—Ñ—Ñ–µ–∫—Ç –ø–µ—á–∞—Ç–∏ —Å –≤–æ–ª–Ω–æ–æ–±—Ä–∞–∑–Ω–æ–π –∞–Ω–∏–º–∞—Ü–∏–µ–π"""
        words = text.split(' ')
        typing_speed = self.config.getfloat('settings', 'typing_speed', fallback=0.03)
        
        print("ü§ñ ", end='', flush=True)
        
        for word_idx, word in enumerate(words):
            if self._stop_typing:
                print(' '.join(words[word_idx:]), end='', flush=True)
                break
            
            # –ü–µ—á–∞—Ç–∞–µ–º —Å–ª–æ–≤–æ –ø–æ—Å–∏–º–≤–æ–ª—å–Ω–æ —Å —Ä–∞–∑–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –≤–æ–ª–Ω—ã
            for i, char in enumerate(word):
                print(char, end='', flush=True)
                # –ú–µ–Ω—è–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –≤–æ–ª–Ω—ã
                wave_speed = typing_speed * (0.8 + 0.4 * (i % 3) / 2)
                time.sleep(wave_speed)
            
            # –ü—Ä–æ–±–µ–ª –º–µ–∂–¥—É —Å–ª–æ–≤–∞–º–∏
            if word_idx < len(words) - 1:
                print(' ', end='', flush=True)
                time.sleep(typing_speed * 1.5)  # –ù–µ–º–Ω–æ–≥–æ –¥–æ–ª—å—à–µ –ø–∞—É–∑–∞ –º–µ–∂–¥—É —Å–ª–æ–≤–∞–º–∏
        
        print()
    
    def stop_typing(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞ –ø–µ—á–∞—Ç–∏"""
        self._stop_typing = True
    
    def ask_ai(self, question: str) -> str:
        """–ó–∞–ø—Ä–æ—Å –∫ –ò–ò"""
        try:
            messages = [
                {"role": "system", "content": self.config.get('settings', 'system_prompt')}
            ]
            messages.extend(self.history)
            messages.append({"role": "user", "content": question})
            
            response = self.client.chat.completions.create(
                model=self.config.get('api', 'model_name'),
                messages=messages,
                temperature=self.config.getfloat('settings', 'temperature', fallback=0.7),
                max_tokens=self.config.getint('settings', 'max_tokens', fallback=1024)
            )
            
            return response.choices[0].message.content.strip()
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞: {e}"
    
    def process_question(self, question: str):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–ø—Ä–æ—Å–∞ —Å –∞–Ω–∏–º–∞—Ü–∏—è–º–∏"""
        # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –æ–∂–∏–¥–∞–Ω–∏—è (–≤—ã–±–µ—Ä–∏—Ç–µ –æ–¥–Ω—É –∏–∑ –¥–≤—É—Ö)
        animation_thread = self.start_waiting_animation()  # –∏–ª–∏ start_thinking_animation()
        
        try:
            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
            answer = self.ask_ai(question)
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –æ–∂–∏–¥–∞–Ω–∏—è
            self.stop_waiting_animation()
            if animation_thread and animation_thread.is_alive():
                animation_thread.join(timeout=0.5)
            
            # –í—ã–≤–æ–¥–∏–º –æ—Ç–≤–µ—Ç —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º –ø–µ—á–∞—Ç–∏
            typing_enabled = self.config.getboolean('settings', 'typing_effect', fallback=True)
            
            if typing_enabled:
                try:
                    # –í—ã–±–µ—Ä–∏—Ç–µ —ç—Ñ—Ñ–µ–∫—Ç –ø–µ—á–∞—Ç–∏
                    self.type_with_effect(answer)  # –ü—Ä–æ—Å—Ç–æ–π —ç—Ñ—Ñ–µ–∫—Ç
                    # –∏–ª–∏ self.type_with_wave_effect(answer)  # –í–æ–ª–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç
                except KeyboardInterrupt:
                    self.stop_typing()
                    print("\n‚èπÔ∏è –ü–µ—á–∞—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞")
            else:
                print(f"\nü§ñ {answer}")
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            self.add_to_history("user", question)
            self.add_to_history("assistant", answer)
            
        except KeyboardInterrupt:
            self.stop_waiting_animation()
            self.stop_typing()
            print("\n‚èπÔ∏è –ó–∞–ø—Ä–æ—Å –ø—Ä–µ—Ä–≤–∞–Ω")
            
        except Exception as e:
            self.stop_waiting_animation()
            print(f"\n‚ùå –û—à–∏–±–∫–∞: {e}")
    
    def interactive_mode(self):
        """–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º"""
        print("ü§ñ AI Terminal –≥–æ—Ç–æ–≤. –î–ª—è –≤—ã—Ö–æ–¥–∞: quit/exit/–≤—ã—Ö–æ–¥")
        print("–î–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: clear")
        print("–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–µ—á–∞—Ç–∏: Ctrl+C\n")
        
        try:
            while True:
                try:
                    question = input("==> ").strip()
                    
                    if question.lower() in ['quit', 'exit', '–≤—ã—Ö–æ–¥']:
                        print("üëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
                        break
                    elif question.lower() == 'clear':
                        self.clear_history()
                        continue
                    elif not question:
                        continue
                    
                    # –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –≤–æ–ø—Ä–æ—Å–∞
                    self.process_question(question)
                    
                    print()  # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
                    
                except KeyboardInterrupt:
                    self.stop_waiting_animation()
                    self.stop_typing()
                    print("\n\nüëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
                    break
                    
        except EOFError:
            print("\nüëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
    
    def single_question(self, question: str):
        """–†–µ–∂–∏–º –æ–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞"""
        self.process_question(question)

def show_help():
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É"""
    print("ü§ñ AI Terminal")
    print("\n–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:")
    print("  ai-terminal [–≤–æ–ø—Ä–æ—Å]    - –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å")
    print("  ai-terminal             - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º")
    print("  ai-terminal --config    - –ü–æ–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É")
    print("  ai-terminal --reset     - –°–±—Ä–æ—Å–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é")
    print("  ai-terminal --help      - –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É")
    print("\n–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: ~/.config/ai-terminal.conf")

def main():
    if len(sys.argv) > 1:
        arg = sys.argv[1]
        
        if arg in ['--help', '-h']:
            show_help()
            return
        elif arg == '--config':
            config_file = Path.home() / ".config" / "ai-terminal.conf"
            history_file = Path.home() / ".config" / "ai-terminal-history.json"
            print(f"üìÅ –ö–æ–Ω—Ñ–∏–≥: {config_file}")
            print(f"üìÅ –ò—Å—Ç–æ—Ä–∏—è: {history_file}")
            return
        elif arg == '--reset':
            history_file = Path.home() / ".config" / "ai-terminal-history.json"
            if history_file.exists():
                history_file.unlink()
                print("üßπ –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞")
            else:
                print("‚ÑπÔ∏è –ò—Å—Ç–æ—Ä–∏—è —É–∂–µ –ø—É—Å—Ç–∞")
            return
        elif arg.startswith('-'):
            print(f"‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç: {arg}")
            show_help()
            return
    
    try:
        assistant = AITerminal()
        
        if len(sys.argv) > 1:
            question = " ".join(sys.argv[1:])
            assistant.single_question(question)
        else:
            assistant.interactive_mode()
            
    except KeyboardInterrupt:
        print("\nüëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
