#!/usr/bin/env python3
import os
import sys
import json
import configparser
import time
import threading
import re
import mimetypes
from pathlib import Path
from datetime import datetime
import openai

class AITerminal:
    def __init__(self):
        self.config_dir = Path.home() / ".config"
        self.config_file = self.config_dir / "ai-terminal.conf"
        self.history_file = self.config_dir / "ai-terminal-history.json"
        self.config = None
        self.history = []
        self.client = None
        self._stop_typing = False
        self._spinner_active = False
        self.attached_files = []
        self.code_blocks_dir = Path.cwd() / "ai_code_blocks"
        self.code_blocks_dir.mkdir(exist_ok=True)

        self.setup_config()
        self.setup_client()
        self.load_history()

    def setup_config(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"""
        if not self.config_file.exists():
            self.create_default_config()
            print(f"üìÅ –ö–æ–Ω—Ñ–∏–≥ —Å–æ–∑–¥–∞–Ω: {self.config_file}")
            print("üîë –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ API –∫–ª—é—á –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ")
            sys.exit(1)

        self.config = configparser.ConfigParser()
        self.config.read(self.config_file)

        api_key = self.config.get('api', 'api_key', fallback='YOUR_API_KEY_HERE')
        if api_key == 'YOUR_API_KEY_HERE':
            print("‚ùå –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ API –∫–ª—é—á –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ")
            sys.exit(1)

    def create_default_config(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
        self.config_dir.mkdir(parents=True, exist_ok=True)

        config = configparser.ConfigParser()
        config['api'] = {
            'base_url': 'https://api.intelligence.io.solutions/api/v1/',
            'api_key': 'YOUR_API_KEY_HERE',
            'model_name': 'meta-llama/Llama-3.3-70B-Instruct'
        }
        config['settings'] = {
            'system_prompt': '–¢—ã –ø–æ–ª–µ–∑–Ω—ã–π AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –û—Ç–≤–µ—á–∞–π —è—Å–Ω–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π markdown —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–æ–º–µ –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞ —Å ```. –î–ª—è –¥–ª–∏–Ω–Ω–æ–≥–æ –∫–æ–¥–∞ (–±–æ–ª—å—à–µ 100 —Å–∏–º–≤–æ–ª–æ–≤) –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–π –µ–≥–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤ –æ—Ç–≤–µ—Ç–µ, –∞ —Å–æ–æ–±—â–∏ —á—Ç–æ –∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —Ñ–∞–π–ª–µ –∏ —É–∫–∞–∂–∏ –µ–≥–æ —Ä–∞–∑–º–µ—Ä. –ö–æ—Ä–æ—Ç–∫–∏–π –∫–æ–¥ –º–æ–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤ –±–ª–æ–∫–∞—Ö ```.',
            'temperature': '0.7',
            'max_tokens': '2048',
            'memory_depth': '5',
            'typing_effect': 'true',
            'typing_speed': '0.03',
            'waiting_animation': 'true'
        }

        with open(self.config_file, 'w') as f:
            config.write(f)

    def setup_client(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ OpenAI"""
        try:
            self.client = openai.OpenAI(
                api_key=self.config.get('api', 'api_key'),
                base_url=self.config.get('api', 'base_url')
            )
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞: {e}")
            sys.exit(1)

    def load_history(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞"""
        try:
            if self.history_file.exists():
                with open(self.history_file, 'r', encoding='utf-8') as f:
                    self.history = json.load(f)
            else:
                self.history = []
                self.save_history()
        except Exception:
            self.history = []

    def save_history(self):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞"""
        try:
            with open(self.history_file, 'w', encoding='utf-8') as f:
                json.dump(self.history, f, ensure_ascii=False, indent=2)
        except Exception:
            pass

    def add_to_history(self, role, content):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—é"""
        if content:
            self.history.append({"role": role, "content": content})
            memory_depth = self.config.getint('settings', 'memory_depth', fallback=5)
            max_history = memory_depth * 2
            if len(self.history) > max_history:
                self.history = self.history[-max_history:]
            self.save_history()

    def clear_history(self):
        """–û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞"""
        self.history = []
        self.save_history()
        print("üßπ –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞")

    def attach_file(self, file_path):
        """–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞"""
        try:
            path = Path(file_path)
            if not path.exists():
                print(f"‚ùå –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω: {file_path}")
                return False

            if path.is_file():
                with open(path, 'r', encoding='utf-8') as f:
                    content = f.read()

                file_info = {
                    'path': str(path),
                    'name': path.name,
                    'content': content,
                    'size': len(content),
                    'attached_at': datetime.now().isoformat()
                }
                self.attached_files.append(file_info)
                print(f"üìé –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω —Ñ–∞–π–ª: {path.name} ({len(content)} —Å–∏–º–≤–æ–ª–æ–≤)")
                return True
            else:
                print(f"‚ùå –≠—Ç–æ –Ω–µ —Ñ–∞–π–ª: {file_path}")
                return False

        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: {e}")
            return False

    def clear_attached_files(self):
        """–û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤"""
        self.attached_files.clear()
        print("üßπ –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –æ—á–∏—â–µ–Ω—ã")

    def show_attached_files(self):
        """–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã"""
        if not self.attached_files:
            print("üìé –ù–µ—Ç –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤")
            return

        print("üìé –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:")
        for i, file_info in enumerate(self.attached_files, 1):
            print(f"  {i}. {file_info['name']} ({file_info['size']} —Å–∏–º–≤–æ–ª–æ–≤)")

    def process_code_blocks(self, text):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –∑–∞–º–µ–Ω–∞ –¥–ª–∏–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞"""
        # –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –±–ª–æ–∫–æ–≤ –∫–æ–¥–∞
        code_block_pattern = r'```(?:\w+)?\n([\s\S]*?)\n```'

        def replace_long_code(match):
            code_content = match.group(1).strip()
            if len(code_content) > 100:
                # –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª –¥–ª—è –¥–ª–∏–Ω–Ω–æ–≥–æ –∫–æ–¥–∞
                timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
                filename = f"ai_code_{timestamp}.txt"
                filepath = self.code_blocks_dir / filename

                with open(filepath, 'w', encoding='utf-8') as f:
                    f.write(code_content)

                return f"[–∫–æ–¥ –ò–ò –Ω–∞: {len(code_content)} —Å–∏–º–≤–æ–ª–æ–≤, —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ {filename}]"
            else:
                # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –±–ª–æ–∫ –¥–ª—è –∫–æ—Ä–æ—Ç–∫–æ–≥–æ –∫–æ–¥–∞
                return match.group(0)

        # –ó–∞–º–µ–Ω—è–µ–º –¥–ª–∏–Ω–Ω—ã–µ –±–ª–æ–∫–∏ –∫–æ–¥–∞
        processed_text = re.sub(code_block_pattern, replace_long_code, text)
        return processed_text

    def build_prompt_with_files(self, question):
        """–ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ —Å –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏"""
        if not self.attached_files:
            return question

        file_contents = []
        for file_info in self.attached_files:
            file_content = f"\n\n--- –§–∞–π–ª: {file_info['name']} ---\n{file_info['content']}\n--- –ö–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞ ---"
            file_contents.append(file_content)

        files_section = "".join(file_contents)
        full_prompt = f"{question}\n\n–ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:{files_section}"

        return full_prompt

    def show_waiting_animation(self):
        """–ê–Ω–∏–º–∞—Ü–∏—è –æ–∂–∏–¥–∞–Ω–∏—è"""
        animation_frames = ['|', '/', '-', '\\']
        i = 0

        while self._spinner_active:
            print(f'\r{animation_frames[i]} –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...', end='', flush=True)
            time.sleep(0.1)
            i = (i + 1) % len(animation_frames)

        print('\r' + ' ' * 50 + '\r', end='', flush=True)

    def start_waiting_animation(self):
        """–ó–∞–ø—É—Å–∫ –∞–Ω–∏–º–∞—Ü–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è"""
        if not self.config.getboolean('settings', 'waiting_animation', fallback=True):
            return None

        self._spinner_active = True
        animation_thread = threading.Thread(target=self.show_waiting_animation)
        animation_thread.daemon = True
        animation_thread.start()
        return animation_thread

    def stop_waiting_animation(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–∏ –æ–∂–∏–¥–∞–Ω–∏—è"""
        self._spinner_active = False
        time.sleep(0.15)

    def type_with_effect(self, text: str):
        """–≠—Ñ—Ñ–µ–∫—Ç –ø–µ—á–∞—Ç–∏ –ø–æ —Å–ª–æ–≤–∞–º"""
        if not text:
            return

        words = text.split(' ')
        typing_speed = self.config.getfloat('settings', 'typing_speed', fallback=0.03)

        print("ü§ñ ", end='', flush=True)

        for word_idx, word in enumerate(words):
            if self._stop_typing:
                print(' '.join(words[word_idx:]), end='', flush=True)
                break

            print(word, end='', flush=True)

            if word_idx < len(words) - 1:
                print(' ', end='', flush=True)

            time.sleep(typing_speed)

        print()

    def stop_typing(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞ –ø–µ—á–∞—Ç–∏"""
        self._stop_typing = True

    def ask_ai(self, question: str) -> str:
        """–ó–∞–ø—Ä–æ—Å –∫ –ò–ò —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫"""
        try:
            messages = [
                {"role": "system", "content": self.config.get('settings', 'system_prompt')}
            ]
            messages.extend(self.history)
            messages.append({"role": "user", "content": question})

            response = self.client.chat.completions.create(
                model=self.config.get('api', 'model_name'),
                messages=messages,
                temperature=self.config.getfloat('settings', 'temperature', fallback=0.7),
                max_tokens=self.config.getint('settings', 'max_tokens', fallback=2048)
            )

            if response and response.choices and len(response.choices) > 0:
                answer = response.choices[0].message.content
                if answer is not None:
                    return answer.strip()
                else:
                    return "‚ö†Ô∏è –ü–æ–ª—É—á–µ–Ω –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò"
            else:
                return "‚ö†Ô∏è –ù–µ—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç –ò–ò"

        except openai.APIError as e:
            return f"‚ùå –û—à–∏–±–∫–∞ API: {str(e)}"
        except openai.OpenAIError as e:
            return f"‚ùå –û—à–∏–±–∫–∞ OpenAI: {str(e)}"
        except Exception as e:
            return f"‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: {str(e)}"

    def process_question(self, question: str):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–ø—Ä–æ—Å–∞ —Å –∞–Ω–∏–º–∞—Ü–∏—è–º–∏"""
        # –î–æ–±–∞–≤–ª—è–µ–º –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∫ –ø—Ä–æ–º–ø—Ç—É
        full_prompt = self.build_prompt_with_files(question)

        # –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –æ–∂–∏–¥–∞–Ω–∏—è
        animation_thread = self.start_waiting_animation()

        try:
            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
            answer = self.ask_ai(full_prompt)

            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
            self.stop_waiting_animation()
            if animation_thread and animation_thread.is_alive():
                animation_thread.join(timeout=0.5)

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç –Ω–∞ –æ—à–∏–±–∫–∏
            if not answer:
                print("\n‚ö†Ô∏è –û—Ç–≤–µ—Ç –æ—Ç –ò–ò –ø—É—Å—Ç")
                return

            if answer.startswith("‚ùå") or answer.startswith("‚ö†Ô∏è"):
                print(f"\n{answer}")
                return

            # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –±–ª–æ–∫–∏ –∫–æ–¥–∞
            processed_answer = self.process_code_blocks(answer)

            # –í—ã–≤–æ–¥–∏–º –æ—Ç–≤–µ—Ç —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º –ø–µ—á–∞—Ç–∏
            typing_enabled = self.config.getboolean('settings', 'typing_effect', fallback=True)

            if typing_enabled:
                try:
                    self.type_with_effect(processed_answer)
                except KeyboardInterrupt:
                    self.stop_typing()
                    print("\n‚èπÔ∏è –ü–µ—á–∞—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞")
            else:
                print(f"\nü§ñ {processed_answer}")

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            self.add_to_history("user", question)
            self.add_to_history("assistant", answer)

            # –û—á–∏—â–∞–µ–º –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
            self.attached_files.clear()

        except KeyboardInterrupt:
            self.stop_waiting_animation()
            self.stop_typing()
            print("\n‚èπÔ∏è –ó–∞–ø—Ä–æ—Å –ø—Ä–µ—Ä–≤–∞–Ω")

        except Exception as e:
            self.stop_waiting_animation()
            print(f"\n‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ: {str(e)}")

    def interactive_mode(self):
        """–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º"""
        print("ü§ñ AI Terminal –≥–æ—Ç–æ–≤. –î–ª—è –≤—ã—Ö–æ–¥–∞: quit/exit/–≤—ã—Ö–æ–¥")
        print("–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:")
        print("  /clear              - –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞")
        print("  /file <–ø—É—Ç—å>        - –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª")
        print("  /files              - –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã")
        print("  /clear_files        - –æ—á–∏—Å—Ç–∏—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã")
        print("  /help               - –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É –ø–æ –∫–æ–º–∞–Ω–¥–∞–º")
        print()

        try:
            while True:
                try:
                    user_input = input("==> ").strip()

                    if user_input.lower() in ['quit', 'exit', '–≤—ã—Ö–æ–¥']:
                        print("üëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
                        break
                    elif user_input.lower() == '/clear':
                        self.clear_history()
                        continue
                    elif user_input.lower() == '/clear_files':
                        self.clear_attached_files()
                        continue
                    elif user_input.lower() == '/files':
                        self.show_attached_files()
                        continue
                    elif user_input.lower() == '/help':
                        print("\nü§ñ –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:")
                        print("  /clear              - –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞")
                        print("  /file <–ø—É—Ç—å>        - –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª")
                        print("  /files              - –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã")
                        print("  /clear_files        - –æ—á–∏—Å—Ç–∏—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã")
                        print("  /help               - –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É")
                        print("  quit/exit/–≤—ã—Ö–æ–¥     - –≤—ã–π—Ç–∏ –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã")
                        print()
                        continue
                    elif user_input.startswith('/file '):
                        file_path = user_input[6:].strip()
                        if file_path:
                            self.attach_file(file_path)
                        else:
                            print("‚ùå –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É: /file <–ø—É—Ç—å>")
                        continue
                    elif user_input.startswith('/'):
                        print(f"‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: {user_input}")
                        print("   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥")
                        continue
                    elif not user_input:
                        continue

                    # –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –≤–æ–ø—Ä–æ—Å–∞
                    self.process_question(user_input)

                    print()  # –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏

                except KeyboardInterrupt:
                    self.stop_waiting_animation()
                    self.stop_typing()
                    print("\n\nüëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
                    break

        except EOFError:
            print("\nüëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")

    def single_question(self, question: str):
        """–†–µ–∂–∏–º –æ–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞"""
        self.process_question(question)

def show_help():
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É"""
    print("ü§ñ AI Terminal")
    print("\n–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:")
    print("  ai-terminal [–≤–æ–ø—Ä–æ—Å]                    - –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å")
    print("  ai-terminal -f —Ñ–∞–π–ª—ã -p \"–ø—Ä–æ–º–ø—Ç\"       - –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª—ã —Å –ø—Ä–æ–º–ø—Ç–æ–º")
    print("  ai-terminal                             - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º")
    print("  ai-terminal --config                    - –ü–æ–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É")
    print("  ai-terminal --clear/--reset             - –°–±—Ä–æ—Å–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é")
    print("  ai-terminal --help                      - –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É")
    print("\n–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:")
    print("  /clear              - –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞")
    print("  /file <–ø—É—Ç—å>        - –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª")
    print("  /files              - –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã")
    print("  /clear_files        - –æ—á–∏—Å—Ç–∏—Ç—å –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã")
    print("  /help               - –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É –ø–æ –∫–æ–º–∞–Ω–¥–∞–º")
    print("\n–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: ~/.config/ai-terminal.conf")
    print("API –∫–ª—é—á –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –Ω–∞: https://cloud.io.net/")

def main():
    import argparse

    parser = argparse.ArgumentParser(description='ü§ñ AI Terminal - –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ò–ò')
    parser.add_argument('question', nargs='*', help='–í–æ–ø—Ä–æ—Å –¥–ª—è –ò–ò')
    parser.add_argument('-f', '--files', help='–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)')
    parser.add_argument('-p', '--prompt', help='–ü—Ä–æ–º–ø—Ç –¥–ª—è –ò–ò')
    parser.add_argument('--config', action='store_true', help='–ü–æ–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É')
    parser.add_argument('--clear', '--reset', action='store_true', help='–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é')
    parser.add_argument('--help-cmd', action='store_true', help='–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É')

    # –ï—Å–ª–∏ –Ω–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∏–ª–∏ —Ç–æ–ª—å–∫–æ help
    if len(sys.argv) == 1 or sys.argv[1] in ['-h', '--help']:
        show_help()
        return

    args = parser.parse_args()

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–ª–∞–≥–æ–≤
    if args.config:
        config_file = Path.home() / ".config" / "ai-terminal.conf"
        history_file = Path.home() / ".config" / "ai-terminal-history.json"
        print(f"üìÅ –ö–æ–Ω—Ñ–∏–≥: {config_file}")
        print(f"üìÅ –ò—Å—Ç–æ—Ä–∏—è: {history_file}")
        return

    if args.clear:
        history_file = Path.home() / ".config" / "ai-terminal-history.json"
        if history_file.exists():
            history_file.unlink()
            print("üßπ –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞")
        else:
            print("‚ÑπÔ∏è –ò—Å—Ç–æ—Ä–∏—è —É–∂–µ –ø—É—Å—Ç–∞")
        return

    if args.help_cmd:
        show_help()
        return

    try:
        assistant = AITerminal()

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏–∑ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
        if args.files and args.prompt:
            file_list = [f.strip() for f in args.files.split(',')]
            for file_path in file_list:
                assistant.attach_file(file_path)
            question = args.prompt
            assistant.single_question(question)
        elif args.files and args.question:
            # –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–∞–π–ª—ã –∏ –≤–æ–ø—Ä–æ—Å –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–∞—Ö
            file_list = [f.strip() for f in args.files.split(',')]
            for file_path in file_list:
                assistant.attach_file(file_path)
            question = " ".join(args.question)
            assistant.single_question(question)
        elif args.prompt:
            # –¢–æ–ª—å–∫–æ –ø—Ä–æ–º–ø—Ç
            assistant.single_question(args.prompt)
        elif args.question:
            # –¢–æ–ª—å–∫–æ –≤–æ–ø—Ä–æ—Å
            question = " ".join(args.question)
            assistant.single_question(question)
        else:
            # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º
            assistant.interactive_mode()

    except KeyboardInterrupt:
        print("\nüëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
    except Exception as e:
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {str(e)}")
        sys.exit(1)

if __name__ == "__main__":
    main()
