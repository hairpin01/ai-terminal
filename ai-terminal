#!/usr/bin/env python3
import os
import sys
import json
import configparser
from pathlib import Path
import openai
import readline  # –î–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –≤–≤–æ–¥–∞ –≤ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–º —Ä–µ–∂–∏–º–µ

class AITerminal:
    def __init__(self):
        self.config_dir = Path.home() / ".config"
        self.config_file = self.config_dir / "ai-terminal.conf"
        self.history_file = self.config_dir / "ai-terminal-history.json"
        self.config = None
        self.history = []
        self.client = None
        
        self.setup_config()
        self.setup_client()
        self.load_history()
    
    def setup_config(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"""
        if not self.config_file.exists():
            self.create_default_config()
            print(f"üìÅ –ö–æ–Ω—Ñ–∏–≥ —Å–æ–∑–¥–∞–Ω: {self.config_file}")
            print("üîë –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤–∞—à API –∫–ª—é—á –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ")
            sys.exit(1)
        
        self.config = configparser.ConfigParser()
        self.config.read(self.config_file)
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º API –∫–ª—é—á
        api_key = self.config.get('api', 'api_key', fallback='YOUR_API_KEY_HERE')
        if api_key == 'YOUR_API_KEY_HERE':
            print("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤–∞—à API –∫–ª—é—á –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ")
            sys.exit(1)
    
    def create_default_config(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
        self.config_dir.mkdir(parents=True, exist_ok=True)
        
        config = configparser.ConfigParser()
        config['api'] = {
            'base_url': 'https://api.intelligence.io.solutions/api/v1/',
            'api_key': 'YOUR_API_KEY_HERE',
            'model_name': 'meta-llama/Llama-3.3-70B-Instruct'
        }
        config['settings'] = {
            'system_prompt': 'You are a helpful AI assistant. Provide clear and concise answers in Russian. Be friendly and professional.',
            'temperature': '0.7',
            'max_tokens': '1024',
            'memory_depth': '5'
        }
        
        with open(self.config_file, 'w') as f:
            config.write(f)
    
    def setup_client(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ OpenAI"""
        try:
            self.client = openai.OpenAI(
                api_key=self.config.get('api', 'api_key'),
                base_url=self.config.get('api', 'base_url')
            )
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞: {e}")
            sys.exit(1)
    
    def load_history(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞"""
        try:
            if self.history_file.exists():
                with open(self.history_file, 'r', encoding='utf-8') as f:
                    self.history = json.load(f)
            else:
                self.history = []
                self.save_history()
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: {e}")
            self.history = []
    
    def save_history(self):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞"""
        try:
            with open(self.history_file, 'w', encoding='utf-8') as f:
                json.dump(self.history, f, ensure_ascii=False, indent=2)
        except Exception as e:
            print(f"‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏: {e}")
    
    def add_to_history(self, role, content):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—é"""
        self.history.append({"role": role, "content": content})
        
        # –û–±—Ä–µ–∑–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –≥–ª—É–±–∏–Ω—ã
        memory_depth = self.config.getint('settings', 'memory_depth', fallback=5)
        max_history = memory_depth * 2
        if len(self.history) > max_history:
            self.history = self.history[-max_history:]
        
        self.save_history()
    
    def clear_history(self):
        """–û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞"""
        self.history = []
        self.save_history()
        print("üßπ –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –æ—á–∏—â–µ–Ω–∞")
    
    def ask_ai(self, question):
        """–ó–∞–ø—Ä–æ—Å –∫ –ò–ò"""
        try:
            # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            messages = [
                {"role": "system", "content": self.config.get('settings', 'system_prompt')}
            ]
            
            # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
            messages.extend(self.history)
            
            # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å
            messages.append({"role": "user", "content": question})
            
            # –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å
            response = self.client.chat.completions.create(
                model=self.config.get('api', 'model_name'),
                messages=messages,
                temperature=self.config.getfloat('settings', 'temperature', fallback=0.7),
                max_tokens=self.config.getint('settings', 'max_tokens', fallback=1024)
            )
            
            answer = response.choices[0].message.content.strip()
            return answer
            
        except openai.APIError as e:
            return f"‚ùå –û—à–∏–±–∫–∞ API: {e}"
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞: {e}"
    
    def print_response(self, question, answer):
        """–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤—ã–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞"""
        try:
            terminal_width = min(80, os.get_terminal_size().columns)
        except:
            terminal_width = 80
        
        separator = "=" * (terminal_width - 2)
        
        print(f"\n/{separator}")
        print(f"| üîú –í–æ–ø—Ä–æ—Å: {question}")
        print(f"| {separator}")
        
        # –†–∞–∑–±–∏–≤–∞–µ–º –æ—Ç–≤–µ—Ç –Ω–∞ —Å—Ç—Ä–æ–∫–∏
        lines = []
        current_line = ""
        for word in answer.split():
            if len(current_line) + len(word) + 1 <= terminal_width - 8:  # 8 –¥–ª—è "| üîô " –∏ –ø—Ä–æ–±–µ–ª–æ–≤
                current_line += " " + word if current_line else word
            else:
                if current_line:
                    lines.append(current_line)
                current_line = word
        
        if current_line:
            lines.append(current_line)
        
        for line in lines:
            print(f"| üîô {line}")
        
        print(f"| {separator}\n")
    
    def interactive_mode(self):
        """–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º"""
        print("ü§ñ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≥–æ—Ç–æ–≤. –î–ª—è –≤—ã—Ö–æ–¥–∞ –≤–≤–µ–¥–∏—Ç–µ 'quit', 'exit' –∏–ª–∏ '–≤—ã—Ö–æ–¥'")
        print("–î–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –≤–≤–µ–¥–∏—Ç–µ 'clear'")
        
        while True:
            try:
                question = input("‚ùì –í–∞—à –≤–æ–ø—Ä–æ—Å: ").strip()
                
                if question.lower() in ['quit', 'exit', '–≤—ã—Ö–æ–¥']:
                    print("üëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
                    break
                elif question.lower() == 'clear':
                    self.clear_history()
                    continue
                elif not question:
                    continue
                
                print("‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∑–∞–ø—Ä–æ—Å...")
                answer = self.ask_ai(question)
                
                if answer.startswith("‚ùå"):
                    print(answer)
                else:
                    self.print_response(question, answer)
                    self.add_to_history("user", question)
                    self.add_to_history("assistant", answer)
                    
            except KeyboardInterrupt:
                print("\nüëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
                break
            except EOFError:
                print("\nüëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
                break
    
    def single_question(self, question):
        """–†–µ–∂–∏–º –æ–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞"""
        print("‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é –∑–∞–ø—Ä–æ—Å...")
        answer = self.ask_ai(question)
        
        if answer.startswith("‚ùå"):
            print(answer)
            sys.exit(1)
        else:
            self.print_response(question, answer)
            self.add_to_history("user", question)
            self.add_to_history("assistant", answer)

def show_help():
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É"""
    print("""ü§ñ –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞

–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
  ai-terminal [–≤–æ–ø—Ä–æ—Å]    - –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ò–ò
  ai-terminal             - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º
  ai-terminal --config    - –ü–æ–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É
  ai-terminal --reset     - –°–±—Ä–æ—Å–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
  ai-terminal --help      - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
  –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: ~/.config/ai-terminal.conf
  –ü–æ–ª—É—á–∏—Ç–µ API –∫–ª—é—á –Ω–∞: https://cloud.io.net/
""")

def main():
    if len(sys.argv) > 1:
        arg = sys.argv[1]
        
        if arg in ['--help', '-h']:
            show_help()
            return
        elif arg == '--config':
            config_file = Path.home() / ".config" / "ai-terminal.conf"
            history_file = Path.home() / ".config" / "ai-terminal-history.json"
            print(f"üìÅ –ö–æ–Ω—Ñ–∏–≥: {config_file}")
            print(f"üìÅ –ò—Å—Ç–æ—Ä–∏—è: {history_file}")
            return
        elif arg == '--reset':
            history_file = Path.home() / ".config" / "ai-terminal-history.json"
            if history_file.exists():
                history_file.unlink()
                print("üßπ –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –æ—á–∏—â–µ–Ω–∞")
            else:
                print("‚ÑπÔ∏è –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ —É–∂–µ –ø—É—Å—Ç–∞")
            return
        elif arg.startswith('-'):
            print(f"‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç: {arg}")
            show_help()
            return
    
    try:
        assistant = AITerminal()
        
        if len(sys.argv) > 1:
            # –†–µ–∂–∏–º –æ–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞
            question = " ".join(sys.argv[1:])
            assistant.single_question(question)
        else:
            # –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º
            assistant.interactive_mode()
            
    except KeyboardInterrupt:
        print("\nüëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
    except Exception as e:
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
