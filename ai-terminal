#!/usr/bin/env python3
import os
import sys
import json
import configparser
import time
import threading
import asyncio
from pathlib import Path
import openai
from typing import Optional

class AITerminal:
    def __init__(self):
        self.config_dir = Path.home() / ".config"
        self.config_file = self.config_dir / "ai-terminal.conf"
        self.history_file = self.config_dir / "ai-terminal-history.json"
        self.config = None
        self.history = []
        self.client = None
        self._stop_typing = False
        self._spinner_active = False
        
        self.setup_config()
        self.setup_client()
        self.load_history()
    
    def setup_config(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"""
        if not self.config_file.exists():
            self.create_default_config()
            print(f"üìÅ –ö–æ–Ω—Ñ–∏–≥ —Å–æ–∑–¥–∞–Ω: {self.config_file}")
            print("üîë –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ API –∫–ª—é—á –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ")
            sys.exit(1)
        
        self.config = configparser.ConfigParser()
        self.config.read(self.config_file)
        
        api_key = self.config.get('api', 'api_key', fallback='YOUR_API_KEY_HERE')
        if api_key == 'YOUR_API_KEY_HERE':
            print("‚ùå –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ API –∫–ª—é—á –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–º —Ñ–∞–π–ª–µ")
            sys.exit(1)
    
    def create_default_config(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é"""
        self.config_dir.mkdir(parents=True, exist_ok=True)
        
        config = configparser.ConfigParser()
        config['api'] = {
            'base_url': 'https://api.intelligence.io.solutions/api/v1/',
            'api_key': 'YOUR_API_KEY_HERE',
            'model_name': 'meta-llama/Llama-3.3-70B-Instruct'
        }
        config['settings'] = {
            'system_prompt': '–¢—ã –ø–æ–ª–µ–∑–Ω—ã–π AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –û—Ç–≤–µ—á–∞–π —è—Å–Ω–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º.',
            'temperature': '0.7',
            'max_tokens': '1024',
            'memory_depth': '5',
            'typing_effect': 'true',
            'typing_speed': '0.05'
        }
        
        with open(self.config_file, 'w') as f:
            config.write(f)
    
    def setup_client(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ OpenAI"""
        try:
            self.client = openai.OpenAI(
                api_key=self.config.get('api', 'api_key'),
                base_url=self.config.get('api', 'base_url')
            )
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞: {e}")
            sys.exit(1)
    
    def load_history(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞"""
        try:
            if self.history_file.exists():
                with open(self.history_file, 'r', encoding='utf-8') as f:
                    self.history = json.load(f)
            else:
                self.history = []
                self.save_history()
        except Exception:
            self.history = []
    
    def save_history(self):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞"""
        try:
            with open(self.history_file, 'w', encoding='utf-8') as f:
                json.dump(self.history, f, ensure_ascii=False, indent=2)
        except Exception:
            pass
    
    def add_to_history(self, role, content):
        """–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—Ä–∏—é"""
        self.history.append({"role": role, "content": content})
        memory_depth = self.config.getint('settings', 'memory_depth', fallback=5)
        max_history = memory_depth * 2
        if len(self.history) > max_history:
            self.history = self.history[-max_history:]
        self.save_history()
    
    def clear_history(self):
        """–û—á–∏—Å—Ç–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–∏–∞–ª–æ–≥–∞"""
        self.history = []
        self.save_history()
        print("üßπ –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞")
    
    async def show_spinner(self, message="–î—É–º–∞—é"):
        """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π —Å–ø–∏–Ω–Ω–µ—Ä –≤–æ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞"""
        spinner_chars = ['‚†ã', '‚†ô', '‚†π', '‚†∏', '‚†º', '‚†¥', '‚†¶', '‚†ß', '‚†á', '‚†è']
        i = 0
        self._spinner_active = True
        
        try:
            while self._spinner_active:
                sys.stdout.write(f"\r{spinner_chars[i]} {message}... ")
                sys.stdout.flush()
                await asyncio.sleep(0.1)
                i = (i + 1) % len(spinner_chars)
        finally:
            sys.stdout.write('\r' + ' ' * (len(message) + 15) + '\r')
            sys.stdout.flush()
    
    def stop_spinner(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–ø–∏–Ω–Ω–µ—Ä–∞"""
        self._spinner_active = False
    
    def type_with_effect(self, text: str):
        """–≠—Ñ—Ñ–µ–∫—Ç –ø–µ—á–∞—Ç–∏ –ø–æ —Å–ª–æ–≤–∞–º —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π"""
        words = text.split(' ')
        typing_speed = self.config.getfloat('settings', 'typing_speed', fallback=0.05)
        cursor_chars = ['|', '/', '‚Äì', '\\']
        cursor_idx = 0
        
        for word_idx, word in enumerate(words):
            if self._stop_typing:
                # –í—ã–≤–æ–¥–∏–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è —Å–ª–æ–≤–∞ –±–µ–∑ —ç—Ñ—Ñ–µ–∫—Ç–∞
                print(' '.join(words[word_idx:]), end='', flush=True)
                break
            
            # –í—ã–≤–æ–¥–∏–º —Å–ª–æ–≤–æ
            print(word, end='', flush=True)
            
            # –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–ª–æ–≤–æ, –¥–æ–±–∞–≤–ª—è–µ–º –ø—Ä–æ–±–µ–ª –∏ –∞–Ω–∏–º–∞—Ü–∏—é
            if word_idx < len(words) - 1:
                print(' ', end='', flush=True)
                sys.stdout.write(cursor_chars[cursor_idx])
                sys.stdout.flush()
                time.sleep(typing_speed)
                sys.stdout.write('\b \b')
                sys.stdout.flush()
                cursor_idx = (cursor_idx + 1) % len(cursor_chars)
            else:
                print('', end='', flush=True)
            
            time.sleep(typing_speed)
        
        print()  # –ó–∞–≤–µ—Ä—à–∞–µ–º —Å—Ç—Ä–æ–∫—É
    
    def stop_typing(self):
        """–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —ç—Ñ—Ñ–µ–∫—Ç–∞ –ø–µ—á–∞—Ç–∏"""
        self._stop_typing = True
    
    async def ask_ai_async(self, question: str) -> str:
        """–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ –ò–ò"""
        try:
            messages = [
                {"role": "system", "content": self.config.get('settings', 'system_prompt')}
            ]
            messages.extend(self.history)
            messages.append({"role": "user", "content": question})
            
            response = self.client.chat.completions.create(
                model=self.config.get('api', 'model_name'),
                messages=messages,
                temperature=self.config.getfloat('settings', 'temperature', fallback=0.7),
                max_tokens=self.config.getint('settings', 'max_tokens', fallback=1024)
            )
            
            return response.choices[0].message.content.strip()
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞: {e}"
    
    async def process_question(self, question: str):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–ø—Ä–æ—Å–∞ —Å –∞–Ω–∏–º–∞—Ü–∏—è–º–∏"""
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –∑–∞–¥–∞—á–µ
        spinner_task = asyncio.create_task(self.show_spinner())
        
        try:
            # –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç
            answer = await self.ask_ai_async(question)
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–ø–∏–Ω–Ω–µ—Ä
            self.stop_spinner()
            await spinner_task
            
            # –í—ã–≤–æ–¥–∏–º –æ—Ç–≤–µ—Ç —Å —ç—Ñ—Ñ–µ–∫—Ç–æ–º –ø–µ—á–∞—Ç–∏
            typing_enabled = self.config.getboolean('settings', 'typing_effect', fallback=True)
            
            if typing_enabled:
                try:
                    self.type_with_effect(answer)
                except KeyboardInterrupt:
                    self.stop_typing()
                    print()
            else:
                print(answer)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∏—Å—Ç–æ—Ä–∏—é
            self.add_to_history("user", question)
            self.add_to_history("assistant", answer)
            
        except Exception as e:
            self.stop_spinner()
            await spinner_task
            print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
    
    def interactive_mode(self):
        """–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º"""
        print("ü§ñ AI Terminal –≥–æ—Ç–æ–≤. –î–ª—è –≤—ã—Ö–æ–¥–∞: quit/exit/–≤—ã—Ö–æ–¥")
        print("–î–ª—è –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: clear")
        print("–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–µ—á–∞—Ç–∏: Ctrl+C\n")
        
        try:
            while True:
                try:
                    question = input("==> ").strip()
                    
                    if question.lower() in ['quit', 'exit', '–≤—ã—Ö–æ–¥']:
                        print("üëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
                        break
                    elif question.lower() == 'clear':
                        self.clear_history()
                        continue
                    elif not question:
                        continue
                    
                    # –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É –≤–æ–ø—Ä–æ—Å–∞
                    asyncio.run(self.process_question(question))
                    
                except KeyboardInterrupt:
                    self.stop_typing()
                    self.stop_spinner()
                    print("\n\nüëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
                    break
                    
        except EOFError:
            print("\nüëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
    
    def single_question(self, question: str):
        """–†–µ–∂–∏–º –æ–¥–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞"""
        asyncio.run(self.process_question(question))

def show_help():
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É"""
    print("ü§ñ AI Terminal")
    print("\n–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:")
    print("  ai-terminal [–≤–æ–ø—Ä–æ—Å]    - –ó–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å")
    print("  ai-terminal             - –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º")
    print("  ai-terminal --config    - –ü–æ–∫–∞–∑–∞—Ç—å –ø—É—Ç—å –∫ –∫–æ–Ω—Ñ–∏–≥—É")
    print("  ai-terminal --reset     - –°–±—Ä–æ—Å–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é")
    print("  ai-terminal --help      - –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É")
    print("\n–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: ~/.config/ai-terminal.conf")

def main():
    if len(sys.argv) > 1:
        arg = sys.argv[1]
        
        if arg in ['--help', '-h']:
            show_help()
            return
        elif arg == '--config':
            config_file = Path.home() / ".config" / "ai-terminal.conf"
            history_file = Path.home() / ".config" / "ai-terminal-history.json"
            print(f"üìÅ –ö–æ–Ω—Ñ–∏–≥: {config_file}")
            print(f"üìÅ –ò—Å—Ç–æ—Ä–∏—è: {history_file}")
            return
        elif arg == '--reset':
            history_file = Path.home() / ".config" / "ai-terminal-history.json"
            if history_file.exists():
                history_file.unlink()
                print("üßπ –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞")
            else:
                print("‚ÑπÔ∏è –ò—Å—Ç–æ—Ä–∏—è —É–∂–µ –ø—É—Å—Ç–∞")
            return
        elif arg.startswith('-'):
            print(f"‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç: {arg}")
            show_help()
            return
    
    try:
        assistant = AITerminal()
        
        if len(sys.argv) > 1:
            question = " ".join(sys.argv[1:])
            assistant.single_question(question)
        else:
            assistant.interactive_mode()
            
    except KeyboardInterrupt:
        print("\nüëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        sys.exit(1)

if __name__ == "__main__":
    main()
